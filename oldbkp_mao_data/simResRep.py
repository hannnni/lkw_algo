#-------------------------------------------------------------------------------
# Name:        module1
# Purpose:
#
# Author:      gu62mal
#
# Created:     22.09.2014
# Copyright:   (c) gu62mal 2014
# Licence:     <your licence>
#-------------------------------------------------------------------------------

import win32com
import win32com.client
import os
import string
import random
import csv
import numpy# as np
import scipy
import GA_New
import allPos

import csv
import sys
#from scipy import stats

#import matplotlib.pyplot as plt

##global debug
##debug = 0

global filename, vissimResultFileName
#define the file name, when it under the same folder with py file.
filename = 'p2'#night scenario
vissimResultFileName = filename+'.fzp'

global simulationtimes, simulationLength, cycle, cycleTimes
#define the number of cycles, cycle time and simulation time
cycle = 10
cycleTimes = 70
simulationLength = cycle * cycleTimes
simulationtimes = 8

global signalPlansForAllRuns,signalplans

#p1, fix seed 15 8 runs:

##signalPlansForAllRuns =[\
##[[3,2,2,4,2],[2,4,4,4,4],[3,2,3,3,3],[3,4,2,3,1],[4,2,1,3,2],[4,2,2,1,3],[3,3,4,2,1],[3,3,1,1,3],[3,4,1,2,1],[4,3,2,1,3]],\
##[[4,1,4,4,3],[3,3,3,2,3],[3,4,2,4,2],[4,2,1,2,4],[1,1,2,3,1],[1,1,1,4,1],[1,1,1,1,3],[2,4,3,2,4],[1,1,2,1,4],[4,4,1,2,4]],\
##[[1,1,4,4,2],[3,3,4,3,1],[3,2,4,4,1],[3,3,2,2,1],[1,1,1,2,2],[4,2,3,1,2],[1,1,2,3,2],[4,1,3,2,3],[1,4,2,4,3],[1,4,2,4,2]],\
##[[4,2,1,1,3],[1,2,1,1,1],[3,4,4,1,2],[1,2,3,1,4],[1,1,3,1,4],[4,4,4,4,4],[3,1,4,1,4],[4,3,2,4,3],[3,4,4,1,4],[3,4,3,1,1]],\
##[[3,1,4,2,4],[3,2,3,2,1],[4,4,2,1,1],[1,4,2,3,4],[2,1,4,2,4],[4,2,4,3,2],[3,2,2,2,2],[3,1,3,1,4],[4,2,4,4,4],[1,3,3,2,1]],\
##[[2,2,3,2,2],[4,3,4,3,3],[2,2,4,3,4],[2,3,4,2,4],[4,3,4,4,4],[1,3,2,2,3],[1,1,2,1,2],[4,1,4,2,4],[4,3,4,3,2],[4,4,3,1,2]],\
##[[1,2,3,3,4],[4,1,3,3,4],[4,2,2,2,1],[3,2,3,2,1],[4,3,2,2,1],[4,1,3,1,4],[4,1,4,1,2],[3,1,4,4,4],[1,4,4,1,4],[1,4,1,3,2]],\
##[[1,2,1,3,2],[2,3,3,1,2],[4,1,1,3,4],[4,3,4,3,2],[2,3,3,1,2],[4,4,4,1,3],[2,3,2,3,3],[3,2,3,4,2],[4,3,3,3,1],[4,4,1,4,3]]]

#p2 fix seed 15
##signalPlansForAllRuns = [\
##[[3,4,2,4,3],[4,1,2,3,2],[4,2,2,4,3],[4,2,2,2,3],[4,4,2,4,4],[4,4,3,4,3],[1,4,3,4,1],[3,3,2,3,2],[4,4,3,2,4],[4,4,2,2,3]],\
##[[1,4,3,3,3],[4,3,1,2,2],[3,2,3,3,2],[3,2,1,4,3],[2,1,2,2,3],[4,4,4,2,1],[2,4,2,1,2],[4,1,2,1,3],[2,4,4,4,1],[4,4,3,1,3]],\
##[[1,3,3,2,2],[4,3,4,1,1],[4,4,4,4,4],[2,2,1,2,2],[3,3,3,2,1],[3,3,3,3,2],[2,4,4,3,4],[1,4,4,2,1],[1,4,2,2,4],[3,4,4,1,4]],\
##[[3,4,1,4,4],[1,1,4,4,2],[3,4,4,3,1],[3,2,3,2,2],[3,4,3,4,3],[1,2,2,3,4],[4,4,4,2,2],[2,2,3,2,2],[1,3,1,1,1],[4,2,2,2,1]],\
##[[1,3,2,2,4],[3,3,2,4,1],[4,2,4,4,4],[1,4,2,1,3],[4,1,3,4,3],[4,1,1,4,4],[1,4,1,3,4],[4,4,3,2,1],[4,2,3,4,1],[3,4,3,2,3]],\
##[[3,1,4,1,1],[3,3,2,3,2],[4,4,1,4,1],[1,3,2,3,3],[1,2,1,3,3],[4,1,2,4,2],[4,3,3,3,2],[3,4,1,3,1],[1,2,4,3,2],[1,2,4,2,3]],\
##[[2,4,4,4,4],[4,3,4,3,3],[4,2,3,1,1],[3,2,1,3,2],[3,4,1,2,1],[3,4,1,1,4],[4,2,2,3,4],[1,4,4,4,4],[1,3,3,4,2],[1,4,3,4,4]],\
##[[4,2,1,1,1],[3,3,1,1,4],[4,2,4,2,3],[3,2,4,3,1],[1,3,1,2,4],[4,4,4,2,3],[4,4,2,1,4],[1,3,2,3,4],[4,4,2,2,1],[2,2,2,4,2]]]

#p1 random seed
##signalPlansForAllRuns = [\
##[[4,2,1,2,2],[2,4,1,2,3],[1,2,4,3,4],[2,2,3,1,3],[4,1,1,1,4],[3,3,3,3,1],[4,3,4,1,4],[3,2,4,4,3],[1,4,1,1,1],[4,4,1,4,3]],\
##[[2,1,3,1,2],[4,4,1,4,2],[1,2,1,4,3],[3,2,1,1,2],[4,4,3,1,1],[4,1,4,3,1],[2,4,3,4,3],[2,2,3,1,3],[4,1,4,1,3],[4,2,1,4,3]],\
##[[4,1,4,4,2],[2,4,1,2,4],[4,4,3,1,3],[1,4,2,3,4],[1,1,1,4,4],[2,2,4,4,3],[2,4,2,2,3],[2,2,1,3,4],[3,1,2,3,3],[3,2,2,2,3]],\
##[[1,3,3,4,4],[4,4,3,2,4],[2,2,3,4,4],[3,2,2,1,1],[4,3,3,2,2],[2,2,3,4,3],[2,3,2,2,2],[1,1,2,3,1],[3,3,2,1,1],[3,4,2,2,3]],\
##[[4,2,1,4,1],[4,3,2,3,4],[1,2,4,1,4],[2,2,3,4,4],[1,1,2,3,4],[1,4,2,2,2],[1,2,3,1,4],[3,1,3,4,2],[4,4,3,4,1],[1,2,3,2,3]],\
##[[2,1,2,1,3],[3,4,3,4,3],[1,4,3,1,2],[1,3,2,3,1],[4,4,1,4,1],[3,4,1,4,4],[4,3,3,2,3],[4,4,1,1,4],[1,1,1,4,2],[2,4,3,3,3]],\
##[[3,2,4,1,3],[4,1,3,4,1],[2,3,4,3,1],[4,1,4,4,1],[3,4,1,4,2],[1,1,3,2,3],[1,4,3,2,4],[4,2,4,1,1],[4,1,1,1,1],[4,4,4,2,3]],\
##[[4,1,3,1,2],[4,1,2,3,3],[3,1,1,2,3],[4,1,4,4,4],[4,4,1,2,4],[4,2,3,4,1],[1,4,2,4,2],[1,3,2,1,4],[4,3,3,4,1],[3,4,3,3,4]]]
##
#p2 random seed
##signalPlansForAllRuns = [\
##[[1,4,2,3,2],[3,4,1,1,3],[4,2,3,2,2],[4,1,3,3,1],[1,4,4,2,1],[4,1,3,1,2],[1,4,3,4,3],[4,3,4,3,2],[1,4,1,1,2],[1,4,1,4,2]],\
##[[4,1,4,2,2],[4,1,1,3,3],[4,4,4,4,4],[1,1,4,1,1],[3,2,3,2,4],[4,2,4,2,2],[3,2,2,2,1],[3,4,3,2,4],[2,4,2,4,4],[4,3,4,2,2]],\
##[[1,1,2,2,1],[4,4,3,2,3],[3,1,1,1,4],[2,2,1,4,1],[4,2,1,2,1],[4,3,1,2,1],[1,3,2,1,2],[4,3,3,3,3],[2,3,2,1,4],[3,3,2,3,4]],\
##[[2,3,1,2,1],[3,1,2,4,2],[3,2,4,2,2],[1,4,1,2,3],[1,2,3,3,1],[1,2,1,1,2],[1,4,4,1,1],[2,1,3,2,1],[3,4,3,2,2],[4,3,1,4,3]],\
##[[3,3,4,4,3],[4,2,4,1,2],[3,3,3,4,2],[1,2,3,2,2],[3,3,1,4,1],[2,1,4,2,2],[1,1,3,3,2],[4,2,2,2,4],[4,4,1,4,2],[4,2,3,4,3]],\
##[[2,3,1,4,4],[1,3,1,3,2],[3,4,4,2,1],[1,4,3,1,2],[1,4,2,1,1],[3,2,4,3,3],[4,3,4,4,3],[1,4,3,4,2],[4,2,4,4,2],[2,1,3,4,3]],\
##[[4,2,4,1,2],[1,4,3,3,2],[2,4,2,3,1],[1,4,1,3,2],[2,4,2,4,3],[4,2,1,1,2],[2,4,4,3,4],[4,2,3,4,2],[3,1,1,1,4],[3,1,4,2,4]],\
##[[4,3,3,2,3],[4,4,1,2,4],[4,2,3,2,1],[1,2,2,4,4],[1,1,1,1,2],[2,4,1,2,3],[3,3,1,2,4],[2,4,4,2,1],[1,4,4,3,4],[4,1,3,1,4]]]

#____________________________________________________________________________
#signalplans = [[1,2,1,1,2],[3,4,2,1,1],[3,2,1,1,4],[4,1,4,2,3],[1,1,1,1,1]]
#signalplans = [[4,3,4,4,1],[3,1,1,3,1],[2,2,1,2,1],[4,2,1,3,3],[1,1,1,1,1]]
#signalplans = [[1,2,1,1,3],[1,4,1,2,4],[3,3,2,4,4],[1,2,1,2,3],[1,1,1,1,1]]
#signalplans = [[4,2,2,4,3],[4,3,1,4,4],[2,3,3,1,2],[4,1,2,1,2],[1,1,1,1,1]]
#signalplans = [[3,2,2,3,2],[2,3,3,1,3],[2,2,2,2,1],[2,1,1,2,1],[1,1,1,1,1]]
#signalplans = [[3,2,2,3,2],[2,1,4,4,2],[4,1,2,4,1],[1,4,1,2,4],[1,1,1,1,1]]
#signalplans = [[3,4,2,4,2],[1,4,4,4,2],[4,3,3,1,4],[3,2,3,1,3],[1,1,1,1,1]]
#signalplans = [[1,3,3,3,4],[1,4,1,2,4],[3,3,2,4,4],[1,2,1,2,3],[1,1,1,1,1]]
#signalplans = [[2,2,1,4,4],[1,4,1,4,4],[2,4,2,1,2],[3,4,4,1,2],[1,1,1,1,1]]
#signalplans = [[4,2,2,2,3],[1,4,1,4,4],[2,4,2,1,2],[3,2,2,1,2],[1,1,1,1,1]]
#signalplans = [[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1]]



global RandomSeed
# Please use a fix  seed Number, in oder to get the same traffic situation fot comparation!
RandomSeed = 15

global HGVType
HGVType = 201

def loadVISSIM():
    cwd = os.getcwd()
    VISSIM = win32com.client.Dispatch("Vissim.Vissim.540");
    VISSIM.LoadNet(cwd + '\\' + filename + '.inp');

    VISSIM_Eval = VISSIM.Evaluation;
    #VISSIM_Eval.SetAttValue("DATACOLLECTION",True);
    VISSIM_Eval.SetAttValue("VEHICLERECORD",True);

    return VISSIM

def runVISSIM(VISSIM):
    VISSIM_Sim = VISSIM.Simulation;

    VISSIM_Sim.RandomSeed = RandomSeed
    #VISSIM_Sim.RandomSeed = random.randint(1,100)

    Vissim_Net = VISSIM.Net
    Vissim_Net_Links = Vissim_Net.Links

    Vissim_SignalControllers = Vissim_Net.SignalControllers
    j = 0


    for i in range(simulationLength):

        VISSIM_Sim.RunSingleStep()


        if (i+1)%cycleTimes == 0:
            #return signal prgramm, or signal plans:
            firstCycleSpIxs = signalplans[j]
##            #firstCycleSpIxs = firstCycleSpIxs[1:6]
##            for i in range(len(firstCycleSpIxs)):
##                firstCycleSpIxs[i] = firstCycleSpIxs[i]+1
            print 'firstCycleSpIxs:', firstCycleSpIxs
            sp = 0
            for controller in Vissim_SignalControllers:
                if sp>4:
                    break
                else:
                    originalSPN = controller.AttValue('PROGRAM')
                    controller.SetAttValue('PROGRAM', firstCycleSpIxs[sp]) #firstCycleSpIxs[sp]+1
                    print 'the signal programm of Intersection ', sp, 'has changed to No.',firstCycleSpIxs[sp]
                    sp = sp+1
            j=j+1
            #return firstCycleSpIxs

##def runFeldTest():
##    VISSIM = loadVISSIM()
##    firstCycleSpIxs = runVISSIM(VISSIM)
##    VISSIM = None



if __name__ == '__main__':

    for i in range(simulationtimes):
        print 'run:',i
        VISSIM = loadVISSIM()
        signalplans = signalPlansForAllRuns[i]
        runVISSIM(VISSIM)
        VISSIM = None
        simulationtime = i+1
        try: os.remove(filename+'_'+str(simulationtime)+'.txt')
        except: pass
        os.rename(vissimResultFileName,filename+'_'+str(simulationtime)+'.txt')
